#!/usr/bin/env bash

set -e

loadkeys us

echo -e "\n\n================================================================================"
echo    "============================== Available devices ==============================="
echo -e "================================================================================\n"
lsblk
echo -e "\n================================================================================"
echo -e "================================================================================\n"

read -p "Enter the device to use: " DEVICE_ID
# ============ BIOS ============
# cfdisk $DEVICE_ID

# ============ UEFI ============
gdisk $DEVICE_ID

echo -e "\n================================================================================"
echo    "============================== Partitioning complete ==========================="
echo -e "================================================================================\n"

echo    "================================================================================"
echo    "============================== Formatting file systems ========================="
echo -e "================================================================================\n"
sleep 1

# ============ BIOS ============
# mkswap "${DEVICE_ID}1"
# swapon "${DEVICE_ID}1"

# mkfs.ext4 "${DEVICE_ID}2"
# mkfs.ext4 "${DEVICE_ID}3"
# mkfs.ext4 "${DEVICE_ID}4"

# ============ UEFI ============
mkfs.vfat "${DEVICE_ID}1"

mkswap "${DEVICE_ID}2"
swapon "${DEVICE_ID}2"

mkfs.ext4 "${DEVICE_ID}3"
mkfs.ext4 "${DEVICE_ID}4"
mkfs.ext4 "${DEVICE_ID}5"

echo -e "\n================================================================================"
echo    "============================== Formatting complete ============================="
echo -e "================================================================================\n"

echo    "================================================================================"
echo    "============================== Mounting file systems ==========================="
echo -e "================================================================================\n"
sleep 1

# ============ BIOS ============
# mount "${DEVICE_ID}2" /mnt
# mkdir /mnt/var
# mount "${DEVICE_ID}3" /mnt/var
# mkdir /mnt/home
# mount "${DEVICE_ID}4" /mnt/home

# ============ UEFI ============
mount "${DEVICE_ID}3" /mnt
mkdir /mnt/boot
mount "${DEVICE_ID}1" /mnt/boot
mkdir /mnt/var
mount "${DEVICE_ID}4" /mnt/var
mkdir /mnt/home
mount "${DEVICE_ID}5" /mnt/home

echo -e "\n================================================================================"
echo    "============================== Mounting complete ==============================="
echo -e "================================================================================\n"

echo    "================================================================================"
echo    "============================== Installing base system =========================="
echo -e "================================================================================\n"
sleep 1

pacstrap /mnt base base-devel
genfstab -U /mnt >> /mnt/etc/fstab

echo -e "\n================================================================================"
echo    "============================== Install complete ================================"
echo -e "================================================================================\n"

echo    "================================================================================"
echo    "============================== Switching to inner system ======================="
echo    "============================== Continue with file 010 =========================="
echo -e "================================================================================\n\n"

cp 020-configuring-core.sh /mnt
arch-chroot /mnt /bin/bash

rm /mnt/020-configuring-core.sh
reboot