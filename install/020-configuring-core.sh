#!/usr/bin/env bash

set -e

echo    "================================================================================"
echo    "============================== Configuring locales ============================="
echo -e "================================================================================\n"
sleep 1

sed -i 's/#en_GB.UTF-8/en_GB.UTF-8/g' /etc/locale.gen
sed -i 's/#en_US.UTF-8/en_US.UTF-8/g' /etc/locale.gen
sed -i 's/#nl_NL.UTF-8/nl_NL.UTF-8/g' /etc/locale.gen
locale-gen
echo LANG=en_US.UTF-8 > /etc/locale.conf
export LANG=en_US.UTF-8
echo -e "KEYMAP=us\nFONT=lat9w-16" > /etc/vconsole.conf

echo -e "\n================================================================================"
echo    "============================== Configuation complete ==========================="
echo -e "================================================================================\n"

echo    "================================================================================"
echo    "============================== Configuring time ================================"
echo -e "================================================================================\n"
sleep 1

ln -sf /usr/share/zoneinfo/Europe/Amsterdam /etc/localtime
hwclock --systohc --utc

echo -e "\n================================================================================"
echo    "============================== Configuation complete ==========================="
echo -e "================================================================================\n"

echo    "================================================================================"
echo    "============================== Configuring network ============================="
echo -e "================================================================================\n"

read -p "Enter the desired hostname: " HOST_NAME
echo $HOST_NAME > /etc/hostname
sed -i "s/localhost./tmp./g" /etc/hosts 
sed -i "s/localhost/localhost ${HOST_NAME}/g" /etc/hosts
sed -i "s/tmp./localhost./g" /etc/hosts

echo -e "\n================================================================================\n"

pacman -S --noconfirm networkmanager
systemctl enable NetworkManager

echo -e "\n================================================================================"
echo    "============================== Configuation complete ==========================="
echo -e "================================================================================\n"

echo    "================================================================================"
echo    "============================== Enter root password ============================="
echo -e "================================================================================\n"

passwd

# ======================================= BIOS ONLY =========================================
# echo -e "\n================================================================================"
# echo    "============================== Generating cpio init ============================"
# echo -e "================================================================================\n"
# sleep 1

# mkinitcpio -p linux

# echo -e "\n================================================================================"
# echo    "============================== Generation complete ============================="
# echo -e "================================================================================\n"

echo    "================================================================================"
echo    "============================== Installing bootloader ==========================="
echo -e "================================================================================\n"

echo    "================================================================================"
echo    "============================== Available devices ==============================="
echo -e "================================================================================\n"
lsblk
echo -e "\n================================================================================\n"

# ========================================= BIOS ===========================================
# read -p "Enter the device for bootloader install: " DEVICE_ID

# echo -e "\n================================================================================\n"

# pacman -S --noconfirm grub
# grub-install --target=i386-pc --recheck $DEVICE_ID
# grub-mkconfig -o /boot/grub/grub.cfg

# ========================================= UEFI ===========================================
read -p "Enter the root partition: " DEVICE_ID

echo -e "\n================================================================================\n"

bootctl install
pacman -S --noconfirm intel-ucode

echo -e "default arch\ntimeout 4\neditor 0" > /boot/loader/loader.conf
echo -e "title Arch Linux\nlinux /vmlinuz-linux\ninitrd /intel-ucode.img\ninitrd /initramfs-linux.img\noptions root=${DEVICE_ID} rw" > /boot/loader/entries/arch.conf

echo -e "\n================================================================================"
echo    "============================== Installation complete ==========================="
echo -e "================================================================================\n"

echo -e "\n================================================================================"
echo    "============================== Adding new user ================================="
echo -e "================================================================================\n"

read -p "Username: " NEW_USER_NAME
useradd -m -g users -G wheel,storage,power -s /bin/bash $NEW_USER_NAME

echo -e "\n================================================================================"
echo    "============================== Enter user password ============================="
echo -e "================================================================================\n"

passwd $NEW_USER_NAME
sed -i "0,/# %wheel/s//%wheel/" /etc/sudoers 

echo -e "\n\n================================================================================"
echo    "============================== System installed succesfully ===================="
echo    "============================== Exit to continue ================================"
echo -e "================================================================================\n\n"